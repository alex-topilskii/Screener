<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Матрица компетенций</title>
  <style>
    body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
    main { flex: 1; display: flex; justify-content: center; align-items: center; }
    aside { width: 350px; border-left: 1px solid #ccc; padding: 12px; overflow:auto }
    .card { width: 300px; padding: 20px; border: 1px solid #ccc; border-radius: 12px;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,.1); text-align:center; }
    .row { display: flex; justify-content: center; margin-top: 12px; gap: 8px; flex-wrap:wrap; }
    button { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; }
    .btn-yes { background: #4caf50; color:white }
    .btn-no { background: #f44336; color:white }
    .btn-unk { background: #2196f3; color:white }
    .badge { background: #eee; border-radius: 8px; padding: 2px 8px; font-size: 12px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    .yes { background: #c8e6c9; }  /* зелёный */
    .no { background: #ffcdd2; }   /* красный */
    .unknown { background: #bbdefb; } /* синий */
  </style>
</head>
<body>

<main>
  <div id="card-container"></div>
</main>

<aside>
  <div class="card">
    <div class="row"><div class="badge">Результаты</div></div>
    <div id="results">Пока пусто.</div>
    <div class="row" style="margin-top:12px;">
      <button id="btn-export">Текст</button>
      <button id="btn-csv">CSV</button>
      <button id="btn-print">Печать</button>
    </div>
    <div id="competency-table"></div>
  </div>
</aside>

<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<script>
// ==== пример YAML ====
const yamlText = `
domains:
  - name: Hard skills
    competencies:
      - id: android_basics
        levels:
          junior:
            skills:
              - Knowledge in Android SDK
              - Kotlin
              - Constraint Layout
          middle:
            skills:
              - Good knowledge in Android SDK
              - Kotlin
              - Constraint Layout
              - Coroutines
              - MVI
              - MVVM
          senior:
            skills:
              - Project architecture design
              - Code review
  - name: Soft skills
    competencies:
      - id: communication
        levels:
          junior:
            skills:
              - Clear verbal communication
          middle:
            skills:
              - Can argue technical decisions
`;

// ==== парсинг YAML ====
const data = jsyaml.load(yamlText);

// ==== состояние ====
const state = {
  domains: [],
  currentDomain: 0,
  currentComp: 0,
  currentLevelIndex: 0,
  currentSkillIndex: 0,
  levels: []
};

// ==== подготовка структуры ====
function prepare() {
  // соберём список уровней
  const levelSet = new Set();
  data.domains.forEach(d => {
    d.competencies.forEach(c => {
      Object.keys(c.levels).forEach(lvl => levelSet.add(lvl));
    });
  });
  state.levels = Array.from(levelSet);

  // разворачиваем items
  data.domains.forEach(d => {
    d.items = [];
    d.competencies.forEach(c => {
      for (const [lvl, obj] of Object.entries(c.levels)) {
        obj.skills.forEach(skill => {
          d.items.push({
            compId: c.id,
            level: lvl,
            text: skill
          });
        });
      }
    });
    d.answers = [];
  });
  state.domains = data.domains;
}

// ==== карточки ====
function showCard() {
  const d = state.domains[state.currentDomain];
  if (!d) { renderResults(); return; }
  const item = d.items[state.currentSkillIndex];
  if (!item) { nextDomain(); return; }

  document.getElementById("card-container").innerHTML = `
    <div class="card">
      <div class="badge">${d.name} – ${item.level}</div>
      <p>${item.text}</p>
      <div class="row">
        <button class="btn-no" onclick="answer('no')">Нет</button>
        <button class="btn-unk" onclick="answer('unknown')">Не знаю</button>
        <button class="btn-yes" onclick="answer('yes')">Да</button>
      </div>
    </div>
  `;
}

function answer(ans) {
  const d = state.domains[state.currentDomain];
  const item = d.items[state.currentSkillIndex];
  d.answers.push({ ...item, answer: ans });
  state.currentSkillIndex++;
  showCard();
}

function nextDomain() {
  state.currentDomain++;
  state.currentSkillIndex = 0;
  showCard();
}

// ==== статистика ====
function computeDomainPercents(domain, levels) {
  const result = {};
  levels.forEach(lvl => {
    const skills = domain.items.filter(i => i.level===lvl);
    if (skills.length===0) { result[lvl] = null; return; }
    const answered = skills.map(i => {
      const a = domain.answers.find(x => x.text===i.text && x.level===i.level);
      return a ? a.answer : null;
    });
    const yesCount = answered.filter(a=>a==="yes").length;
    result[lvl] = Math.round(100*yesCount/skills.length);
  });
  return result;
}

// ==== вывод результатов ====
function renderResults() {
  let html = "";
  for (const d of state.domains) {
    const perc = computeDomainPercents(d, state.levels);
    html += `<h4>${d.name}</h4>`;
    for (const lvl of state.levels) {
      if (perc[lvl]!=null) {
        html += `<div>${lvl}: ${perc[lvl]}%</div>`;
      }
    }
  }
  document.getElementById("results").innerHTML = html;
  renderCompetencyTable();
}

// ==== таблица компетенций ====
function renderCompetencyTable() {
  let html = "<table><tr><th>Domain</th><th>Competency</th><th>Level</th><th>Skill</th><th>Answer</th></tr>";
  for (const d of state.domains) {
    for (const it of d.items) {
      const ans = d.answers.find(a=>a.text===it.text && a.level===it.level);
      const cls = ans ? ans.answer : "";
      html += `<tr>
        <td>${d.name}</td>
        <td>${it.compId}</td>
        <td>${it.level}</td>
        <td>${it.text}</td>
        <td class="${cls}">${ans?ans.answer:""}</td>
      </tr>`;
    }
  }
  html += "</table>";
  document.getElementById("competency-table").innerHTML = html;
}

// ==== экспорт ====
function exportAsText() {
  let out = '';
  for (const d of state.domains) {
    const perc = computeDomainPercents(d, state.levels);
    out += `Домен: ${d.name}\n`;
    state.levels.forEach(lvl=>{
      if (perc[lvl]!=null) out += `  ${lvl}: ${perc[lvl]}%\n`;
    });
    out += '\n';
  }
  return out.trim();
}

function exportAsCSV() {
  const rows = [["domain","competency_id","level","skill","answer"]];
  for (const d of state.domains) {
    d.items.forEach(it=>{
      const ans = d.answers.find(a=>a.text===it.text && a.level===it.level);
      rows.push([d.name,it.compId,it.level,'"'+it.text.replace(/"/g,'""')+'"', ans?ans.answer:""]);
    });
  }
  return rows.map(r=>r.join(",")).join("\n");
}

document.getElementById("btn-export").addEventListener("click", async ()=>{
  const txt = exportAsText();
  try {
    await navigator.clipboard.writeText(txt);
    alert("Скопировано:\n\n"+txt);
  } catch(e) {
    alert("Скопируйте:\n\n"+txt);
  }
});

document.getElementById("btn-csv").addEventListener("click", ()=>{
  const csv = exportAsCSV();
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download="results.csv";
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
});

document.getElementById("btn-print").addEventListener("click", ()=>{
  const txt = exportAsText();
  const win = window.open("", "PRINT", "height=600,width=800");
  win.document.write('<pre>'+txt+'</pre>');
  win.document.close(); win.focus(); win.print();
});

// ==== запуск ====
prepare();
showCard();
</script>

</body>
</html>
